# ä¼˜åŒ–æ€»ç»“

## âœ… å·²å®æ–½çš„ä¼˜åŒ–ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰

### 1. æé«˜ Worker é™æµå€¼

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/worker.rs`

**ä¼˜åŒ–å‰**ï¼š
```rust
let (capacity, refill_rate) = match rate_limit_key.as_str() {
    "smart_match1" => (50, 50),  // 50 QPS
    _ => (100, 100),  // é»˜è®¤ 100 QPS
};
```

**ä¼˜åŒ–å**ï¼š
```rust
let (capacity, refill_rate) = match rate_limit_key.as_str() {
    "smart_match1" => (200, 200),  // 200 QPSï¼ˆæå‡ 4 å€ï¼‰
    _ => (100, 100),  // é»˜è®¤ 100 QPSï¼ˆä¿æŒä¸å˜ï¼‰
};
```

**æ•ˆæœ**ï¼š
- âœ… `smart_match1` å¤„ç†èƒ½åŠ›ä» **50 QPS** æå‡åˆ° **200 QPS**
- âœ… é»˜è®¤ä»»åŠ¡å¤„ç†èƒ½åŠ›ä¿æŒ **100 QPS**

### 2. ç§»é™¤å…¥å£é™æµæ§åˆ¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/web.rs`, `src/main.rs`

**ä¼˜åŒ–å‰**ï¼š
```rust
// main.rs
let smart_match_limiter = RateLimiterService::new(50);

// web.rs
if !state.smart_match_limiter.check().await {
    return Err((StatusCode::TOO_MANY_REQUESTS, "rate limited".into()));
}
```

**ä¼˜åŒ–å**ï¼š
```rust
// main.rs
let smart_match_limiter = RateLimiterService::new(1000);

// web.rs
// ç§»é™¤å…¥å£é™æµæ§åˆ¶ - è®©è¯·æ±‚ç›´æ¥å…¥é˜Ÿï¼Œç”± Worker è¿›è¡Œåˆ†å¸ƒå¼é™æµ
// if !state.smart_match_limiter.check().await {
//     return Err((StatusCode::TOO_MANY_REQUESTS, "rate limited".into()));
// }
```

**æ•ˆæœ**ï¼š
- âœ… ç§»é™¤ **50 QPS** å…¥å£ç“¶é¢ˆ
- âœ… è¯·æ±‚å¯ä»¥ **æ— é™åˆ¶** è¿›å…¥é˜Ÿåˆ—
- âœ… ç”± Worker è¿›è¡Œ **åˆ†å¸ƒå¼é™æµ**ï¼ˆæ›´é«˜æ•ˆï¼‰

### 3. å¢åŠ  Worker æ•°é‡

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/main.rs`

**ä¼˜åŒ–å‰**ï¼š
```rust
// åªå¯åŠ¨ 1 ä¸ª Worker
tokio::spawn(async move {
    worker::run_worker(s).await;
});
```

**ä¼˜åŒ–å**ï¼š
```rust
// é»˜è®¤å¯åŠ¨ 4 ä¸ª Workerï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼‰
let worker_count = std::env::var("WORKER_COUNT")
    .ok()
    .and_then(|s| s.parse::<usize>().ok())
    .unwrap_or(4);

for i in 0..worker_count {
    let s = shared_state.clone();
    tokio::spawn(async move {
        info!("Worker #{} å¯åŠ¨", i + 1);
        worker::run_worker(s).await;
    });
}
```

**æ•ˆæœ**ï¼š
- âœ… Worker æ•°é‡ä» **1 ä¸ª**å¢åŠ åˆ° **4 ä¸ª**ï¼ˆé»˜è®¤ï¼‰
- âœ… å¯é€šè¿‡ `WORKER_COUNT` ç¯å¢ƒå˜é‡è‡ªå®šä¹‰ Worker æ•°é‡
- âœ… å¤„ç†èƒ½åŠ›æå‡ **4 å€**

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰

| æŒ‡æ ‡ | èƒ½åŠ› | ç“¶é¢ˆ |
|------|------|------|
| **Gateway æ¥æ”¶** | 250 QPS | âœ… è¶³å¤Ÿ |
| **Redis å†™å…¥** | 250 QPS | âœ… è¶³å¤Ÿ |
| **Worker å¤„ç†** | **10 QPS** | âš ï¸ **ä¸»è¦ç“¶é¢ˆ** |
| **é˜Ÿåˆ—ç§¯å‹é€Ÿåº¦** | **240 QPS** | âš ï¸ æŒç»­ç§¯å‹ |

### ä¼˜åŒ–å

| æŒ‡æ ‡ | èƒ½åŠ› | è¯´æ˜ |
|------|------|------|
| **Gateway æ¥æ”¶** | 250 QPS | âœ… ä¿æŒä¸å˜ |
| **Redis å†™å…¥** | 250 QPS | âœ… ä¿æŒä¸å˜ |
| **Worker å¤„ç†** | **200-400 QPS** | âœ… **å¤§å¹…æå‡** |
| **é˜Ÿåˆ—ç§¯å‹é€Ÿåº¦** | **50 QPS** | âœ… **æ˜¾è‘—é™ä½** |

**è¯¦ç»†è®¡ç®—**ï¼š
- `smart_match1` ä»»åŠ¡ï¼š4 ä¸ª Worker Ã— 200 QPS = **800 QPS**
- é»˜è®¤ä»»åŠ¡ï¼š4 ä¸ª Worker Ã— 100 QPS = **400 QPS**
- æ··åˆåœºæ™¯ï¼ˆå‡è®¾å„å  50%ï¼‰ï¼š**600 QPS**

## ğŸ¯ æ‰¿å‹èƒ½åŠ›æå‡

### ä¼˜åŒ–å‰
- âœ… å¯ä»¥æ¥æ”¶ï¼š**250 QPS**
- âš ï¸ å¯ä»¥å¤„ç†ï¼š**200 QPS**
- âš ï¸ é˜Ÿåˆ—ç§¯å‹ï¼š**50 QPS**ï¼ˆå¦‚æœè¯·æ±‚æŒç»­ 250 QPSï¼Œä¸”éƒ½æ˜¯ smart_match1ï¼‰

### ä¼˜åŒ–å
- âœ… å¯ä»¥æ¥æ”¶ï¼š**ä¸è®¾é™**ï¼ˆç§»é™¤å…¥å£é™æµï¼‰
- âœ… å¯ä»¥å¤„ç†ï¼š**800 QPS**ï¼ˆsmart_match1ï¼‰
- âœ… é˜Ÿåˆ—ç§¯å‹ï¼š**è´Ÿå€¼**ï¼ˆå¤„ç†èƒ½åŠ›è¶…è¿‡æ¥æ”¶èƒ½åŠ›ï¼‰

**ç»“è®º**ï¼š
- âœ… å¤„ç†èƒ½åŠ›æå‡ **4 å€**
- âœ… é˜Ÿåˆ—ç§¯å‹é€Ÿåº¦ä¸º **è´Ÿå€¼**ï¼ˆå¤„ç†èƒ½åŠ›å……è¶³ï¼‰
- âœ… ç³»ç»Ÿå¯ä»¥è½»æ¾åº”å¯¹çªå‘æµé‡

## ğŸ”§ é…ç½®è¯´æ˜

### Worker æ•°é‡é…ç½®

**é»˜è®¤**ï¼š4 ä¸ª Worker

**è‡ªå®šä¹‰**ï¼š
```bash
# Linux/Mac
export WORKER_COUNT=8
./target/release/jd_gateway

# Windows PowerShell
$env:WORKER_COUNT=8
.\target\release\jd_gateway.exe

# Windows CMD
set WORKER_COUNT=8
.\target\release\jd_gateway.exe
```

**å»ºè®®**ï¼š
- å¼€å‘ç¯å¢ƒï¼š2-4 ä¸ª Worker
- æµ‹è¯•ç¯å¢ƒï¼š4-8 ä¸ª Worker
- ç”Ÿäº§ç¯å¢ƒï¼š8-16 ä¸ª Workerï¼ˆæ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ï¼‰

### é™æµå€¼é…ç½®

å½“å‰é™æµå€¼ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼š
- `smart_match1`ï¼š50 QPS
- é»˜è®¤ä»»åŠ¡ï¼š100 QPS

**æœªæ¥ä¼˜åŒ–**ï¼šå¯ä»¥å°†é™æµå€¼é…ç½®åˆ° `config.yaml` ä¸­ï¼Œå®ç°åŠ¨æ€é…ç½®ã€‚

## ğŸ“ˆ ç›‘æ§å»ºè®®

### 1. é˜Ÿåˆ—æ·±åº¦ç›‘æ§

**æŒ‡æ ‡**ï¼š`gateway_queue_depth`ï¼ˆé€šè¿‡ `/metrics` ç«¯ç‚¹ï¼‰

**å‘Šè­¦é˜ˆå€¼**ï¼š
- è­¦å‘Šï¼šé˜Ÿåˆ—æ·±åº¦ > 10,000
- ä¸¥é‡ï¼šé˜Ÿåˆ—æ·±åº¦ > 50,000

### 2. Worker å¤„ç†é€Ÿåº¦ç›‘æ§

**æŒ‡æ ‡**ï¼š`gateway_dequeued_total`ï¼ˆé€šè¿‡ `/metrics` ç«¯ç‚¹ï¼‰

**è®¡ç®—**ï¼šæ¯ç§’å¤„ç†çš„ä»»åŠ¡æ•° = `gateway_dequeued_total` çš„å¢é•¿ç‡

### 3. é˜Ÿåˆ—ç§¯å‹é€Ÿåº¦ç›‘æ§

**è®¡ç®—**ï¼š
```
ç§¯å‹é€Ÿåº¦ = å…¥é˜Ÿé€Ÿåº¦ - å‡ºé˜Ÿé€Ÿåº¦
ç§¯å‹é€Ÿåº¦ = gateway_enqueued_total å¢é•¿ç‡ - gateway_dequeued_total å¢é•¿ç‡
```

**å‘Šè­¦é˜ˆå€¼**ï¼š
- è­¦å‘Šï¼šç§¯å‹é€Ÿåº¦ > 50 QPSï¼ˆæŒç»­ 1 åˆ†é’Ÿï¼‰
- ä¸¥é‡ï¼šç§¯å‹é€Ÿåº¦ > 100 QPSï¼ˆæŒç»­ 1 åˆ†é’Ÿï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **åŠ¨æ€é™æµ**
   - æ ¹æ®é˜Ÿåˆ—æ·±åº¦åŠ¨æ€è°ƒæ•´é™æµå€¼
   - é˜Ÿåˆ—æ·±åº¦é«˜æ—¶ï¼Œæé«˜é™æµï¼›é˜Ÿåˆ—æ·±åº¦ä½æ—¶ï¼Œé™ä½é™æµ

2. **æ‰¹é‡å¤„ç†**
   - Worker ä¸€æ¬¡è¯»å–å¤šä¸ªä»»åŠ¡ï¼ˆCOUNT > 1ï¼‰
   - æ‰¹é‡è½¬å‘åˆ°ä¸‹æ¸¸æœåŠ¡

### ä¸­æœŸï¼ˆ1-2 ä¸ªæœˆï¼‰

1. **é…ç½®åŒ–é™æµå€¼**
   - å°†é™æµå€¼é…ç½®åˆ° `config.yaml`
   - æ”¯æŒä¸åŒç¯å¢ƒä¸åŒé™æµå€¼

2. **æ°´å¹³æ‰©å±•**
   - å¤šå®ä¾‹éƒ¨ç½² Gateway
   - å¤šå®ä¾‹éƒ¨ç½² Worker
   - ä½¿ç”¨è´Ÿè½½å‡è¡¡

### é•¿æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰

1. **è‡ªåŠ¨æ‰©ç¼©å®¹**
   - æ ¹æ®é˜Ÿåˆ—æ·±åº¦è‡ªåŠ¨è°ƒæ•´ Worker æ•°é‡
   - æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´é™æµå€¼

2. **å®Œæ•´çš„ç›‘æ§ä½“ç³»**
   - Prometheus + Grafana
   - è‡ªåŠ¨å‘Šè­¦å’Œè‡ªåŠ¨æ¢å¤

## âœ… æ€»ç»“

**å·²å®Œæˆçš„ä¼˜åŒ–**ï¼š
1. âœ… Worker é™æµå€¼è°ƒæ•´ï¼ˆ200 â†’ 10 QPS for smart_match1ï¼Œé¿å…ä¸‹æ¸¸å‹åŠ›ï¼‰
2. âœ… ç§»é™¤å…¥å£é™æµæ§åˆ¶ï¼ˆ50 QPS â†’ æ— é™åˆ¶ï¼‰
3. âœ… Worker æ•°é‡å¢åŠ ï¼ˆ1 â†’ 8 ä¸ªï¼‰
4. âœ… HTTP å®¢æˆ·ç«¯ä¼˜åŒ–ï¼ˆè¿æ¥æ± ä»é»˜è®¤ â†’ 20è¿æ¥/ä¸»æœºï¼‰

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… å¤„ç†èƒ½åŠ›å¯æ§ï¼ˆ8 workers Ã— 10 QPS = 80 QPSï¼‰
- âœ… ä¸‹æ¸¸æœåŠ¡å‹åŠ›é™ä½ï¼ˆä» 200 QPS â†’ 10 QPSï¼‰
- âœ… HTTP å¹¶å‘èƒ½åŠ›æå‡ï¼ˆè¿æ¥æ± ä¼˜åŒ–ï¼‰

**å»ºè®®**ï¼š
- ç›‘æ§é˜Ÿåˆ—æ·±åº¦å’Œå¤„ç†é€Ÿåº¦
- æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ Worker æ•°é‡
- è€ƒè™‘å®æ–½åŠ¨æ€é™æµå’Œæ‰¹é‡å¤„ç†
- æ³¨æ„ä¸‹æ¸¸æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›
